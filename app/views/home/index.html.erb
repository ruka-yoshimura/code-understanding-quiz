<% if user_signed_in? %>
<section class="profile-dashboard">
  <div class="dashboard-layout">
    <div class="dashboard-main">
      <div class="dashboard-header">
        <div class="user-info">
          <h2>こんにちは、<%= current_user.display_name %> さん</h2>
          <div class="user-title-display" style="justify-content: flex-start;">
            <span class="rank-badge <%= user_rank_class(current_user) %>" id="dashboard-user-title"><%= user_title(current_user) %></span>
          </div>
          <p>あなたのコード理解を深め、レベルアップを目指しましょう！</p>
        </div>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">現在のレベル</div>
          <div class="stat-value"><%= current_user.level %></div>
        </div>
        <div class="stat-card">
          <div class="stat-label">現在のXP</div>
          <div class="stat-value" id="dashboard-user-xp"><%= current_user.xp %></div>
        </div>
        <div class="stat-card" id="user-streak-container">
          <div class="stat-label">連続回答</div>
          <div class="stat-value">🔥 <span id="dashboard-user-daily-streak"><%= current_user.daily_streak %></span> 日</div>
        </div>
        <div class="stat-card" style="cursor: pointer; transition: transform 0.2s;" onclick="location.href='<%= quizzes_path %>'">
          <div class="stat-label">生成したクイズ</div>
          <div class="stat-value"><%= current_user.posts.joins(:quizzes).count %> 問</div>
          <div style="font-size: 0.8rem; color: #94a3b8; text-align: right; margin-top: 5px;">履歴を見る →</div>
        </div>
        <div class="stat-card" style="cursor: pointer; transition: transform 0.2s;" onclick="location.href='<%= official_posts_path %>'">
          <div class="stat-label" style="color: #10b981;">公式ドリル</div>
          <div class="stat-value" style="font-size: 1rem; color: #10b981;">挑戦する →</div>
        </div>
      </div>

      <div class="xp-section" id="user-xp-section">
        <div class="xp-label-row">
          <span>次のレベルまで</span>
          <span id="dashboard-user-xp-percentage-text"><%= current_user.xp %> / <%= current_user.required_xp_for_next_level %> XP</span>
        </div>
        <div class="xp-progress-bar">
          <div class="xp-progress-fill" id="dashboard-user-xp-progress-fill" style="width: <%= current_user.xp_progress_percentage %>%"></div>
        </div>
      </div>
    </div>

    <%# 側面の特別アクションエリア %>
    <div class="dashboard-sidebar">
      <div class="review-action-card">
        <div class="icon">📊</div>
        <h3>学習分析</h3>
        <div style="display: flex; flex-direction: column; gap: 8px; margin: 10px 0; font-size: 0.85rem;">
          <%
             total_answers = current_user.quiz_answers.count
             incorrect_answers = current_user.quiz_answers.where(correct: false).count
             correct_rate = total_answers > 0 ? ((total_answers - incorrect_answers).to_f / total_answers * 100).round : 0
          %>
          <div style="display: flex; justify-content: space-between;">
            <span style="color: #94a3b8;">回答数:</span>
            <span><%= total_answers %> 問</span>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <span style="color: #f43f5e;">間違い:</span>
            <span><%= incorrect_answers %> 問</span>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <span style="color: #10b981;">正解率:</span>
            <span><%= correct_rate %> %</span>
          </div>
        </div>
        <%= link_to "間違えた問題に再挑戦 (#{current_user.weak_quizzes.count})", reviews_path, class: "button primary", style: "width: 100%; box-sizing: border-box; font-size: 0.8rem; text-align: center;" %>
      </div>
    </div>
  </div>
</section>

<%# デモレベル切り替えパネル（デモユーザーのみ表示） %>
<% if ['beginner@example.com', 'intermediate@example.com', 'expert@example.com'].include?(current_user.email) %>
<section class="demo-switcher-section" style="margin: 20px 0; padding: 20px; background: rgba(30, 41, 59, 0.5); border-radius: 12px; border: 1px dashed rgba(255, 255, 255, 0.1);">
  <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 20px;">
    <div style="display: flex; align-items: center; gap: 15px;">
      <div style="font-size: 1.5rem;">🧪</div>
      <div>
        <h3 style="margin: 0; font-size: 1rem;">デモレベル切り替え</h3>
        <p style="margin: 0; font-size: 0.8rem; color: #94a3b8;">レビュー用にユーザーの状態を即座に切り替えられます</p>
      </div>
    </div>
    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
      <%= link_to "初級レベル (Lv.1)", users_demo_sign_in_path(level: 1), data: { "turbo-method": :post }, class: "button secondary", style: "font-size: 0.8rem; padding: 10px 20px; border: 1px solid rgba(16, 185, 129, 0.3); color: #10b981;" %>
      <%= link_to "中級レベル (Lv.29)", users_demo_sign_in_path(level: 29), data: { "turbo-method": :post }, class: "button secondary", style: "font-size: 0.8rem; padding: 10px 20px; border: 1px solid rgba(59, 130, 246, 0.3); color: #3b82f6;" %>
      <%= link_to "上級レベル (Lv.49)", users_demo_sign_in_path(level: 49), data: { "turbo-method": :post }, class: "button secondary", style: "font-size: 0.8rem; padding: 10px 20px; border: 1px solid rgba(245, 158, 11, 0.3); color: #f59e0b;" %>
    </div>
  </div>
</section>
<% end %>

<div class="index-header">
  <h1>マイコード (<%= current_user.posts.count %>)</h1>
  <%= link_to "新規投稿", new_post_path, class: "button primary" %>
</div>

<div class="posts">
  <% @posts.each do |post| %>
  <div class="post-card">
    <h2 style="margin-top:0;"><%= link_to post.title, post %></h2>
    <p style="font-size: 0.875rem; color: #94a3b8;">
      作成日: <%= post.created_at.strftime("%Y/%m/%d") %> | 生成クイズ: <%= post.quizzes.count %> 問
    </p>
    <p><%= truncate(post.content, length: 150) %></p>
    <%= link_to "クイズに挑戦する →", post, class: "button secondary", style: "margin-top: 10px; font-size: 0.875rem;" %>
  </div>
  <% end %>
</div>
<% else %>
<div class="hero-section">
  <div class="hero-content">
    <h1>Code Understanding Quiz</h1>
    <p class="hero-description">
      AIがあなたのコードからクイズを生成。<br>
      コードを深く理解し、レベルアップを目指しましょう !
    </p>
    <div class="hero-actions" style="display: flex; flex-direction: column; gap: 20px; align-items: center; width: 100%;">
      <div style="display: flex; gap: 15px; width: 100%; max-width: 400px;">
        <%= link_to "新規登録", new_user_registration_path, class: "button primary", style: "flex: 1; text-align: center;" %>
        <%= link_to "ログイン", new_user_session_path, class: "button secondary", style: "flex: 1; text-align: center;" %>
      </div>
      <div style="text-align: center; margin-top: 10px; background: rgba(59, 130, 246, 0.1); padding: 15px; border-radius: 12px; border: 1px solid rgba(59, 130, 246, 0.2); width: 100%; max-width: 400px;">
        <p style="color: #94a3b8; font-size: 0.85rem; margin-bottom: 10px;">デモ用です。サンプルデータが入っています。</p>
        <%= link_to "ゲストログインで体験する", users_guest_sign_in_path, data: { "turbo-method": :post }, class: "button primary", style: "display: block; width: 100%; padding: 12px; font-size: 1rem; background: linear-gradient(135deg, #3b82f6, #2563eb); box-sizing: border-box;" %>
      </div>
    </div>
  </div>
</div>
<% end %>
