<%# ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®æ›´æ–° (ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®ä¸¡æ–¹ã‚’å¯¾è±¡ã«ã™ã‚‹) %>
<% if user_signed_in? %>
  <%# ç§°å·ã®æ›´æ–° %>
  <% new_title = user_title(current_user) %>
  <%= turbo_stream.update "user-title", new_title %>
  <%= turbo_stream.update "dashboard-user-title", new_title %>

  <%# ãƒ¬ãƒ™ãƒ«ã¨XPã®æ›´æ–° %>
  <%= turbo_stream.update "user-level", current_user.level %>
  <%= turbo_stream.update "dashboard-user-level", current_user.level %>

  <%= turbo_stream.update "user-xp", current_user.total_xp %>
  <%= turbo_stream.update "dashboard-user-xp", current_user.total_xp %>

  <%# ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã®æ›´æ–° %>
  <% xp_progress = current_user.xp_progress_percentage %>
  <%= turbo_stream.update "dashboard-user-xp-percentage-text" do %>
    <span class="text-xs font-mono text-slate-400">ã‚ã¨ <strong class="text-white text-sm"><%= current_user.xp_until_next_level %></strong> XP</span>
    <span class="text-[10px] font-mono text-slate-400">(<%= current_user.xp %> / <%= current_user.required_xp_for_next_level %> XP)</span>
  <% end %>
  <%= turbo_stream.replace "dashboard-user-xp-progress-fill" do %>
    <div class="xp-progress-fill" id="dashboard-user-xp-progress-fill" style="width: <%= xp_progress %>%"></div>
  <% end %>

  <%# ã‚¹ãƒˆãƒªãƒ¼ã‚¯ã®æ›´æ–° %>
  <%= turbo_stream.update "dashboard-user-daily-streak", current_user.daily_streak %>
  <% if current_user.daily_streak > 0 %>
    <%# ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®ã‚«ãƒ¼ãƒ‰ã«ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ ã™ã‚‹ãŸã‚ã®å‡¦ç† %>
    <%= turbo_stream.replace "user-streak-container" do %>
      <div class="stat-card streak-highlight" id="user-streak-container">
        <div class="stat-label">é€£ç¶šå›ç­”</div>
        <div class="stat-value">ğŸ”¥ <span id="dashboard-user-daily-streak"><%= current_user.daily_streak %></span> æ—¥</div>
      </div>
    <% end %>
  <% end %>
<% end %>

<%# é€šçŸ¥ã®ãƒˆãƒªã‚¬ãƒ¼ %>
<% if @result[:xp_gained] > 0 %>
  <%# ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”Ÿæˆ %>
  <%
    message = "<strong>#{@result[:xp_gained]} XPç²å¾—ï¼</strong>"
    bonus_details = []
    bonus_details << "åˆè¦‹æ­£è§£ãƒœãƒ¼ãƒŠã‚¹ (+5 XP)" if @result[:bonus_applied]
    bonus_details << "ã‚³ãƒ³ãƒœãƒœãƒ¼ãƒŠã‚¹ (+20 XP)" if @result[:combo_bonus]
    bonus_details << "é€£ç¶šãƒ­ã‚°ã‚¤ãƒ³ãƒœãƒ¼ãƒŠã‚¹ (#{@result[:streak_multiplier]}å€)" if @result[:streak_multiplier].to_f > 1.0

    if bonus_details.any?
      message += "<br><span class='text-sm text-gray' style='font-size: 0.9em;'>" + bonus_details.join("<br>") + "</span>"
    end
  %>

  <%# XPç²å¾—ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ï¼ˆæ­£è§£æ™‚ï¼‰ %>
  <%= turbo_stream.append "notifications" do %>
    <div data-controller="notification"
         data-notification-type-value="popup"
         data-notification-title-value="æ­£è§£ï¼"
         data-notification-html-value="<%= message %>"
         data-notification-icon-value="success"
         data-notification-timer-value="1500">
    </div>
  <% end %>


  <%# ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—æ¼”å‡º %>
  <% if @result[:level_up] %>
    <%= turbo_stream.append "notifications" do %>
      <div data-controller="notification"
           data-notification-type-value="levelUp"
           data-notification-level-value="<%= @result[:new_level] %>"
           data-notification-title-value="<%= user_title(current_user) %>"
           data-notification-timer-value="1500">
      </div>
    <% end %>
  <% end %>

  <%# ç§°å·æ˜‡æ ¼ã®é€šçŸ¥ï¼ˆãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ã¨ã¯åˆ¥ã«åˆ¤å®šãƒ»è¡¨ç¤ºï¼‰ %>
  <% if @result[:title_changed] %>
    <%= turbo_stream.append "notifications" do %>
      <div data-controller="notification"
           data-notification-type-value="popup"
           data-notification-title-value="ç§°å·ãƒ©ãƒ³ã‚¯ã‚¢ãƒƒãƒ—ï¼"
           data-notification-html-value="æ–°ãŸãªç§°å· <strong><%= @result[:new_title_text] %></strong> ã‚’ç²å¾—ã—ã¾ã—ãŸï¼"
           data-notification-icon-value="success"
           data-notification-timer-value="2500">
      </div>
    <% end %>
  <% end %>
<% else %>
  <%# ä¸æ­£è§£ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— %>
  <%= turbo_stream.append "notifications" do %>
    <div data-controller="notification"
         data-notification-type-value="popup"
         data-notification-title-value="æ®‹å¿µï¼ä¸æ­£è§£ã§ã™"
         data-notification-icon-value="error"
         data-notification-timer-value="1500">
    </div>
  <% end %>

  <% if @result[:penalty_applied] %>
    <%= turbo_stream.append "notifications" do %>
      <div data-controller="notification"
           data-notification-type-value="popup"
           data-notification-title-value="3é€£ç¶šä¸æ­£è§£ãƒšãƒŠãƒ«ãƒ†ã‚£"
           data-notification-html-value="çµŒé¨“å€¤ãŒ <strong>-10 XP</strong> æ¸›ç®—ã•ã‚Œã¾ã—ãŸ"
           data-notification-icon-value="warning"
           data-notification-timer-value="2500">
      </div>
    <% end %>
  <% end %>
<% end %>
